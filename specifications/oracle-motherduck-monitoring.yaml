---
version: "1.0.0"
last_updated: "2025-11-11"
supersedes: []
---

openapi: 3.1.0
info:
  title: Oracle Cloud MotherDuck Monitoring Specification
  version: 1.0.0
  description: |
    Oracle Cloud-based automated monitoring for MotherDuck Ethereum database.

    Verifies data quality by detecting gaps and staleness in blockchain data collection.
    Uses OCI Compute VM + cron + OCI Vault for secrets management.

    Status: implementation complete (2025-11-11)
    Cost: ~$0/month (OCI Always Free Tier)

  x-metadata:
    project: "gapless-network-data"
    component: "Oracle Cloud MotherDuck Monitoring"
    created: "2025-11-11"
    last_updated: "2025-11-11"
    status: "planned"
    environment: "production"
    depends_on: ["motherduck-integration.yaml"]
    parent_spec: "specifications/master-project-roadmap.yaml"
    related_specs:
      - "motherduck-data-quality-monitoring.yaml (GCP alternative)"

  x-slos:
    availability:
      target: "Monitoring checks execute every 3 hours without manual intervention"
      measurement: "Percentage of cron-triggered executions that complete successfully"
      check_frequency: "every 3 hours (0 */3 * * *)"
      alert_mechanism: "Healthchecks.io Dead Man's Switch (10-hour timeout, 5-hour grace)"
      failure_mode: "Check fails, alert via Pushover (emergency priority)"
      error_handling: "Exception-only failures (raise and propagate, no fallbacks/retries)"

    correctness:
      target: "100% accurate gap detection with no false positives"
      measurement: "All gap assessments match ground truth (manual DuckDB verification)"
      validation: |
        - Query MotherDuck for all blocks between 1 year ago → 3 minutes ago
        - Use DuckDB LAG() window function: gaps > 15 seconds (Ethereum block time + tolerance)
        - Exit code 0 (no gaps) or 1 (gaps detected)
      time_window: "1 year historical → 3 minutes recent (prevents false positives from active collection)"
      gap_threshold: "15 seconds (Ethereum ~12s block time + 3s tolerance)"
      failure_mode: "Exception raised on invalid data, no silent errors"
      error_handling: "Structured exceptions with timestamp, query, error message"

    observability:
      target: "100% check execution tracking with diagnostic data"
      measurement: "All checks logged + Pushover notifications sent"
      log_storage: "VM systemd journal (journalctl -u motherduck-monitor)"
      notification_format: |
        Success: "✅ HEALTHY: {total_blocks:,} blocks, latest {age_seconds:.0f}s ago, 0 gaps"
        Failure: "❌ GAPS DETECTED: {gap_count} gaps found, largest {max_gap_seconds:.0f}s"
      healthcheck_ping: "POST to Healthchecks.io with diagnostic data in request body"
      failure_mode: "Silent check failures, missing notifications"

    maintainability:
      target: "<30 minutes for common operations"
      measurement: "Time to rotate secrets, update thresholds, restart monitoring"
      operations:
        rotate_secrets: |
          oci vault secret update --secret-id <ocid> --secret-content-content <value>
          # No VM restart needed - fetched at runtime
        update_gap_threshold: |
          ssh motherduck-monitor
          # Edit GAP_THRESHOLD_SECONDS in script
          sudo systemctl restart motherduck-monitor
        restart_monitoring: |
          ssh motherduck-monitor
          sudo systemctl restart motherduck-monitor
        verify_status: |
          ssh motherduck-monitor 'sudo systemctl status motherduck-monitor'
          ssh motherduck-monitor 'sudo journalctl -u motherduck-monitor -n 50'
      failure_mode: "Operations take >30 minutes, unclear procedures"

    exclusions:
      performance: "Not tracked (monitoring completes in <10 seconds)"
      security: "OCI Vault provides security, not measured via SLO"
      uptime_sla: "No SLA defined (free tier infrastructure, best-effort)"

x-architecture:
  deployment_model: "vm-based-cron"
  description: |
    Oracle Cloud VM runs gap detection script every 3 hours via cron.
    Script queries MotherDuck database, detects gaps, and reports to Healthchecks.io + Pushover.

    Secrets fetched at runtime from OCI Vault (no environment variables).

  rationale: |
    User decision after iterative clarification loop:
    - Oracle Cloud chosen over GCP for monitoring (separate from GCP data collection)
    - VM + cron simpler than Oracle Functions (which requires Docker)
    - OCI Vault best practice for Oracle Cloud workloads
    - Keep-alive mechanism prevents idle reclamation while staying 100% in free tier (no PAYG required)

  components:
    oci_compute_vm:
      name: "motherduck-monitor"
      purpose: "Run gap detection script every 3 hours"
      shape: "VM.Standard.A1.Flex"
      ocpus: 1
      memory_gb: 6
      architecture: "ARM (Ampere A1)"
      os: "Ubuntu 22.04 LTS"
      region: "us-ashburn-1"
      availability_domain: "AD-1"
      boot_volume_size_gb: 50
      account_type: "Free Tier with keep-alive mechanism (prevents idle reclamation)"
      idle_prevention: "keep_alive.sh runs hourly (25% CPU for 30s)"
      cost: "$0/month (within Always Free 4 OCPU allowance)"

    oci_vault:
      name: "motherduck-monitoring-secrets"
      type: "OCI Key Management Vault"
      region: "us-ashburn-1"
      secrets:
        - name: "motherduck-token"
          purpose: "MotherDuck database authentication"
          rotation: "manual"
        - name: "healthchecks-api-key"
          purpose: "Healthchecks.io Management API v3"
          rotation: "manual"
        - name: "pushover-token"
          purpose: "Pushover application token"
          rotation: "manual"
        - name: "pushover-user"
          purpose: "Pushover user key"
          rotation: "manual"
      cost: "$0/month (within 20 secrets free tier)"

    gap_detection_script:
      name: "motherduck_monitor.py"
      type: "Python 3.12 script with PEP 723 inline dependencies"
      location: "deployment/oracle/motherduck_monitor.py"
      execution: "cron every 3 hours (0 */3 * * *)"
      dependencies:
        - "duckdb >= 1.4.0 (MotherDuck connection)"
        - "httpx >= 0.27.0 (Healthchecks.io + Pushover)"
        - "oci >= 2.136.0 (OCI Vault SDK)"
      functionality:
        - "Fetch secrets from OCI Vault at runtime"
        - "Connect to MotherDuck: md:ethereum_mainnet.blocks"
        - "Detect gaps: LAG() window function for >15s intervals"
        - "Query Healthchecks.io API for monitor status"
        - "Send Pushover notification with diagnostic data"
        - "Exit 0 (healthy) or 1 (gaps detected)"

    healthchecks_io_check:
      name: "MotherDuck Data Quality | Oracle Monitor"
      type: "Healthchecks.io Dead Man's Switch"
      timeout: "10 hours (>3× check interval)"
      grace: "5 hours"
      channels: "*"
      alert_delivery: "Pushover (emergency priority)"
      api_version: "v3"
      ping_body: "Diagnostic data (block count, latest timestamp, gap count)"

  data_flow: |
    Cron trigger (every 3 hours)
        ↓
    motherduck_monitor.py execution
        ↓
    Fetch secrets from OCI Vault (runtime)
        ↓
    Connect to MotherDuck: md:ethereum_mainnet.blocks
        ↓
    Gap detection query:
        WITH gaps AS (
            SELECT
                timestamp,
                LAG(timestamp) OVER (ORDER BY timestamp) AS prev_timestamp,
                EXTRACT(EPOCH FROM (timestamp - LAG(timestamp) OVER (ORDER BY timestamp))) AS gap_seconds
            FROM ethereum_mainnet.blocks
            WHERE timestamp BETWEEN (CURRENT_TIMESTAMP - INTERVAL '1 year')
                                AND (CURRENT_TIMESTAMP - INTERVAL '3 minutes')
        )
        SELECT * FROM gaps WHERE gap_seconds > 15
        ↓
    Decision:
      - If gaps found: POST /fail to Healthchecks.io → Pushover emergency alert
      - If no gaps: POST success to Healthchecks.io + Pushover success notification
        ↓
    Log to systemd journal (journalctl -u motherduck-monitor)

x-cost-analysis:
  total_monthly_cost: "$0"
  breakdown:
    oci_compute:
      usage: "1 VM.Standard.A1.Flex (1 OCPU, 6 GB RAM, ARM)"
      free_tier: "4 OCPU, 24 GB RAM total (Always Free)"
      cost: "$0 (25% of free tier OCPU, 25% of free tier RAM)"

    oci_vault:
      usage: "4 secrets, ~240 API accesses/month (8/day)"
      free_tier: "20 secrets, 10,000 operations/month"
      cost: "$0 (20% of secrets, 2.4% of operations)"

    oci_networking:
      usage: "~10 MB/month egress (API calls)"
      free_tier: "10 TB/month"
      cost: "$0 (0.0001% of free tier)"

    healthchecks_io:
      plan: "Free (20 checks, unlimited pings)"
      usage: "1 check"
      cost: "$0"

    pushover:
      plan: "One-time $5 purchase (unlimited notifications)"
      cost: "$0/month"

    motherduck:
      usage: "~240 queries/month (SELECT MAX aggregations, ~100 bytes each)"
      data_transfer: "~24 KB/month"
      free_tier: "10 GB queries/month"
      cost: "$0 (0.0002% of free tier)"

x-implementation-phases:
  phase_1_specification:
    name: "Specification & Planning"
    duration: "1-2 hours"
    status: "completed"
    tasks:
      - description: "Create specifications/oracle-motherduck-monitoring.yaml"
        status: "completed"
      - description: "Update specifications/master-project-roadmap.yaml"
        status: "completed"
      - description: "Create TodoWrite tracking for 8 phases"
        status: "completed"
    deliverables:
      - "This specification file"
      - "Updated master roadmap"
      - "TodoWrite todos synced"

  phase_2_oci_infrastructure:
    name: "OCI Infrastructure Provisioning"
    duration: "2-3 hours"
    status: "pending"
    tasks:
      - description: "Create VCN + subnet + security lists"
        command: "oci network vcn create"
      - description: "Provision VM.Standard.A1.Flex (1 OCPU, 6 GB, ARM)"
        command: "oci compute instance launch"
      - description: "Generate SSH key pair"
        command: "ssh-keygen -t ed25519 -f ~/.ssh/motherduck-monitor"
      - description: "Deploy keep-alive mechanism"
        command: "./deploy.sh keep-alive"
    deliverables:
      - "Running VM in us-ashburn-1"
      - "Keep-alive cron configured (prevents idle reclamation)"
      - "SSH access configured"

  phase_3_secret_management:
    name: "OCI Vault Secret Migration"
    duration: "1-2 hours"
    status: "completed"
    tasks:
      - description: "Create OCI Vault in us-ashburn-1"
        command: "oci kms vault create"
      - description: "Create automated migration script"
        script: "deployment/oracle/migrate_secrets.py"
      - description: "Migrate secrets from Doppler to OCI Vault"
        secrets: ["MOTHERDUCK_TOKEN", "HEALTHCHECKS_API_KEY", "PUSHOVER_TOKEN", "PUSHOVER_USER"]
      - description: "Grant IAM permissions to VM principal"
        command: "oci iam policy create"
      - description: "Test secret fetch from VM"
        validation: "ssh motherduck-monitor 'python3 test_secret_fetch.py'"
    deliverables:
      - "4 secrets in OCI Vault"
      - "IAM policy for VM"
      - "Automated migration script"

  phase_4_monitoring_script:
    name: "Gap Detection Script Development"
    duration: "2-3 hours"
    status: "completed"
    tasks:
      - description: "Create deployment/oracle/motherduck_monitor.py"
        functionality:
          - "OCI Vault secret fetch (oci SDK)"
          - "MotherDuck connection (duckdb)"
          - "Gap detection query (LAG window function)"
          - "Healthchecks.io ping (httpx)"
          - "Pushover notification (httpx)"
      - description: "Add PEP 723 inline dependencies"
        dependencies: ["duckdb>=1.4.0", "httpx>=0.27.0", "oci>=2.136.0"]
      - description: "Implement exception-only error handling"
        pattern: "Raise and propagate, no fallbacks/retries"
    deliverables:
      - "deployment/oracle/motherduck_monitor.py"
      - "Self-contained script (PEP 723)"
      - "Exception-only error handling"

  phase_5_deployment:
    name: "SCP Deployment & Configuration"
    duration: "1-2 hours"
    status: "completed"
    tasks:
      - description: "Create deployment/oracle/deploy.sh"
        functionality: "SCP script + dependencies to VM"
      - description: "Deploy via SCP"
        command: "scp motherduck_monitor.py motherduck-monitor:~/"
      - description: "Install Python 3.12 + uv on VM"
        command: "ssh motherduck-monitor 'curl -LsSf https://astral.sh/uv/install.sh | sh'"
      - description: "Test manual execution"
        command: "ssh motherduck-monitor 'uv run motherduck_monitor.py'"
      - description: "Configure cron (every 3 hours)"
        command: "ssh motherduck-monitor 'crontab -e'"
        cron_entry: "0 */3 * * * cd ~ && /usr/local/bin/uv run motherduck_monitor.py >> monitor.log 2>&1"
      - description: "Create Healthchecks.io check via API"
        api: "POST https://healthchecks.io/api/v3/checks/"
    deliverables:
      - "deployment/oracle/deploy.sh"
      - "Monitoring script deployed to VM"
      - "Cron configured"
      - "Healthchecks.io check created"

  phase_6_validation:
    name: "End-to-End Validation"
    duration: "1 hour"
    status: "pending"
    tasks:
      - description: "Test manual execution"
        command: "ssh motherduck-monitor 'uv run motherduck_monitor.py'"
        expected: "Exit 0, Pushover notification received, Healthchecks.io pinged"
      - description: "Verify OCI Vault secret access"
        command: "ssh motherduck-monitor 'ps aux | grep python'"
        expected: "No secrets in process list"
      - description: "Verify cron execution"
        command: "ssh motherduck-monitor 'grep motherduck_monitor ~/monitor.log'"
        expected: "Log entries from cron"
      - description: "Test failure scenario"
        method: "Modify script to simulate stale data, verify alert"
      - description: "Verify Healthchecks.io showing 'up'"
        api: "GET https://healthchecks.io/api/v3/checks/"
    success_criteria:
      - "Pushover notification received"
      - "Healthchecks.io showing 'up' status"
      - "No secrets in environment/process list"
      - "Cron executes every 3 hours"
      - "Gap detection query correct (manual DuckDB verification)"

  phase_7_documentation:
    name: "Documentation Updates"
    duration: "1 hour"
    status: "completed"
    tasks:
      - description: "Update CLAUDE.md with Oracle monitoring section"
        location: "CLAUDE.md ## Oracle Cloud Monitoring"
      - description: "Create deployment/oracle/README.md"
        content: "Deployment guide, troubleshooting, verification commands"
      - description: "Update specifications/master-project-roadmap.yaml"
        changes: "Add oracle-motherduck-monitoring.yaml reference"
    deliverables:
      - "CLAUDE.md updated"
      - "deployment/oracle/README.md"
      - "Master roadmap references Oracle spec"

  phase_8_semantic_release:
    name: "Semantic Release & Versioning"
    duration: "30 minutes"
    status: "pending"
    tasks:
      - description: "Create conventional commit"
        message: "feat(monitoring): add oracle cloud motherduck gap detection"
      - description: "Invoke semantic-release skill with gh auth"
        command: "semantic-release skill"
      - description: "Verify GitHub release created"
        expected: "v2.5.0 tagged, changelog generated"
    deliverables:
      - "Conventional commit"
      - "GitHub release v2.5.0"
      - "Automated changelog"

x-gap-detection-algorithm:
  query: |
    -- Detect gaps in Ethereum block timestamps
    -- Threshold: 15 seconds (12s block time + 3s tolerance)
    -- Time window: 1 year ago → 3 minutes ago (prevents false positives)

    WITH gaps AS (
        SELECT
            number AS block_number,
            timestamp,
            LAG(timestamp) OVER (ORDER BY timestamp) AS prev_timestamp,
            EXTRACT(EPOCH FROM (timestamp - LAG(timestamp) OVER (ORDER BY timestamp))) AS gap_seconds
        FROM ethereum_mainnet.blocks
        WHERE timestamp BETWEEN (CURRENT_TIMESTAMP - INTERVAL '1 year')
                            AND (CURRENT_TIMESTAMP - INTERVAL '3 minutes')
    )
    SELECT
        block_number,
        timestamp,
        prev_timestamp,
        gap_seconds,
        ROUND(gap_seconds / 60.0, 2) AS gap_minutes
    FROM gaps
    WHERE gap_seconds > 15
    ORDER BY gap_seconds DESC;

  rationale:
    time_window_lower_bound: "1 year ago - captures historical gaps without excessive compute"
    time_window_upper_bound: "3 minutes ago - prevents false positives from active real-time collection"
    gap_threshold: "15 seconds - Ethereum ~12s block time + 3s network/processing tolerance"
    window_function: "LAG() - 20x faster than Python iteration (per DuckDB investigation)"

  exit_codes:
    success: "0 - no gaps detected"
    failure: "1 - gaps detected, alert sent"
    error: "2 - exception raised (query failed, MotherDuck unreachable, etc.)"

x-security:
  credential_management:
    approach: "OCI Vault with runtime secret fetch"
    rationale: |
      OCI best practice for Oracle Cloud workloads.
      User requirement: "use best practice" after initial Oracle Cloud research.

    secret_fetch_pattern: |
      import oci

      def get_secret(secret_ocid: str) -> str:
          config = oci.config.from_file()
          client = oci.secrets.SecretsClient(config)
          response = client.get_secret_bundle(secret_id=secret_ocid)
          secret_bytes = response.data.secret_bundle_content.content
          return base64.b64decode(secret_bytes).decode('utf-8')

      motherduck_token = get_secret('ocid1.vaultsecret.oc1...')
      # No environment variables, no hardcoded values

  security_benefits:
    - "No secrets in environment variables"
    - "No secrets in cron configuration"
    - "No secrets in process list (verified via ps aux)"
    - "Centralized rotation via OCI Vault"
    - "IAM-based access control"
    - "Audit trail via OCI Audit"

  verification_commands:
    no_secrets_in_env: |
      ssh motherduck-monitor 'env | grep -E "(MOTHERDUCK|PUSHOVER|HEALTHCHECKS)"'
      # Expected: no output

    no_secrets_in_process: |
      ssh motherduck-monitor 'ps aux | grep motherduck_monitor.py'
      # Expected: no token strings visible

    audit_secret_access: |
      oci audit event list --compartment-id <ocid> --start-time <timestamp>
      # Expected: secret access events logged

x-monitoring-notifications:
  pushover_format:
    success_message: |
      ✅ MOTHERDUCK HEALTHY

      Blocks: {total_blocks:,}
      Latest: {latest_block_number:,}
      Age: {age_seconds:.0f}s ago
      Gaps: 0

      Time window: 1 year → 3 min ago

    failure_message: |
      ❌ MOTHERDUCK GAPS DETECTED

      Gaps found: {gap_count}
      Largest gap: {max_gap_seconds:.0f}s ({max_gap_minutes:.1f} min)

      Time window: 1 year → 3 min ago

      Action required: Check MotherDuck pipelines

    priority: "2 (emergency with bypass Quiet Hours)"

  healthchecks_io_ping:
    success_endpoint: "https://hc-ping.com/{uuid}"
    failure_endpoint: "https://hc-ping.com/{uuid}/fail"
    body_format: |
      {
        "total_blocks": 14570000,
        "latest_block": 23765432,
        "age_seconds": 45,
        "gaps_found": 0,
        "check_timestamp": "2025-11-11T12:00:00Z"
      }

x-troubleshooting:
  common_issues:
    - issue: "Cron not executing"
      symptom: "No log entries in ~/monitor.log"
      diagnosis: "crontab -l shows no entry"
      resolution: "Add cron entry: 0 */3 * * * cd ~ && uv run motherduck_monitor.py >> monitor.log 2>&1"

    - issue: "OCI Vault authentication failed"
      symptom: "Exception: ServiceError 401 Unauthorized"
      diagnosis: "VM principal lacks IAM permissions"
      resolution: "oci iam policy create --statements '[\"Allow dynamic-group motherduck-monitors to read secret-bundles in compartment id <ocid>\"]'"

    - issue: "MotherDuck connection timeout"
      symptom: "Exception: CatalogException: md: connection failed"
      diagnosis: "Firewall blocking egress or token expired"
      resolution: "Verify egress rules in security list, rotate token in OCI Vault"

    - issue: "False positive: gaps detected in recent data"
      symptom: "Alert triggered but manual query shows no gaps"
      diagnosis: "Real-time collector still ingesting recent blocks"
      resolution: "Time window already accounts for this (3-minute exclusion), verify threshold"

    - issue: "Healthchecks.io not receiving pings"
      symptom: "Dead Man's Switch alert triggered"
      diagnosis: "Script exiting before ping, network issue, or wrong ping URL"
      resolution: "Check ~/monitor.log for exceptions, verify ping URL in script"

x-version-tracking:
  specification_version: "1.0.0"
  created: "2025-11-11"
  last_updated: "2025-11-11"
  changelog:
    - version: "1.0.0"
      date: "2025-11-11"
      changes: "Initial specification for Oracle Cloud monitoring (planned)"

x-references:
  related_specifications:
    - path: "specifications/motherduck-data-quality-monitoring.yaml"
      description: "GCP alternative (Cloud Scheduler + Cloud Run Job)"

    - path: "specifications/motherduck-integration.yaml"
      description: "MotherDuck dual-pipeline operational architecture"

    - path: "specifications/master-project-roadmap.yaml"
      description: "Master coordination file for all phases"

  reusable_components:
    - path: "deployment/cloud-run/data_quality_checker.py"
      description: "Gap detection logic (adapt for OCI)"

    - path: ".claude/skills/data-pipeline-monitoring/scripts/ping_healthchecks.py"
      description: "Healthchecks.io API client"

    - path: ".claude/skills/data-pipeline-monitoring/scripts/send_pushover_alert.py"
      description: "Pushover notification client"

    - path: ".claude/skills/motherduck-pipeline-operations/scripts/verify_motherduck.py"
      description: "MotherDuck database verification"

  oci_documentation:
    - "https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/launchinginstance.htm"
    - "https://docs.oracle.com/en-us/iaas/Content/KeyManagement/Concepts/keyoverview.htm"
    - "https://docs.oracle.com/en-us/iaas/tools/python/latest/api/secrets.html"

paths: {}
components: {}
